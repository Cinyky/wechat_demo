var _Page;function _defineProperty(t,e,a){return e in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}var api=require("../../../api.js"),utils=require("../../../utils.js"),app=getApp(),WxParse=require("../../../wxParse/wxParse.js");Page((_defineProperty(_Page={data:{show_attr_picker:!1,form:{number:1}},onLoad:function(t){app.pageOnLoad(this);var e=0,a=t.user_id;console.log("options=>"+JSON.stringify(t));var o=decodeURIComponent(t.scene);if(null!=a)e=a;else if(null!=o){console.log("scene string=>"+o);var i=utils.scene_decode(o);console.log("scene obj=>"+JSON.stringify(i)),i.uid&&i.gid?(e=i.uid,t.gid=i.gid):e=o}app.loginBindParent({parent_id:e}),this.setData({id:t.gid}),this.getGoodsInfo(t);var r=wx.getStorageSync("store");this.setData({store:r})},onReady:function(){},onShow:function(){app.pageOnShow(this)},onHide:function(){},onUnload:function(){},onPullDownRefresh:function(){},onReachBottom:function(){},onShareAppMessage:function(){var t=this,e=wx.getStorageSync("user_info"),a="/pages/pt/details/details?gid="+t.data.goods.id+"&user_id="+e.id;return{title:t.data.goods.name,path:a,imageUrl:t.data.goods.cover_pic,success:function(t){console.log(a)}}},getGoodsInfo:function(t){var e=t.gid,o=this;wx.showLoading({title:"正在加载",mask:!0}),wx.showNavigationBarLoading(),app.request({url:api.group.details,method:"get",data:{gid:e},success:function(t){if(0==t.code){o.countDownRun(t.data.info.limit_time_ms);var e=t.data.info.detail;WxParse.wxParse("detail","html",e,o),wx.setNavigationBarTitle({title:t.data.info.name}),wx.hideNavigationBarLoading();var a=(t.data.info.original_price-t.data.info.price).toFixed(2);o.setData({goods:t.data.info,attr_group_list:t.data.attr_group_list,limit_time:t.data.limit_time_res,group_list:t.data.groupList,group_num:t.data.groupList.length,group_rule_id:t.data.groupRuleId,comment:t.data.comment,comment_num:t.data.commentNum,reduce_price:a<0?0:a}),o.countDown(),o.selectDefaultAttr()}else wx.showModal({title:"提示",content:t.msg,showCancel:!1,success:function(t){t.confirm&&wx.redirectTo({url:"/pages/pt/index/index"})}})},complete:function(t){setTimeout(function(){wx.hideLoading()},1e3)}})},selectDefaultAttr:function(){var t=this;if(t.data.goods&&"0"===t.data.goods.use_attr){for(var e in t.data.attr_group_list)for(var a in t.data.attr_group_list[e].attr_list)0==e&&0==a&&(t.data.attr_group_list[e].attr_list[a].checked=!0);t.setData({attr_group_list:t.data.attr_group_list})}},countDown:function(t){},countDownRun:function(r){var n=this;setInterval(function(){var t=new Date(r[0],r[1]-1,r[2],r[3],r[4],r[5])-new Date,e=parseInt(t/1e3/60/60/24,10),a=parseInt(t/1e3/60/60%24,10),o=parseInt(t/1e3/60%60,10),i=parseInt(t/1e3%60,10);e=n.checkTime(e),a=n.checkTime(a),o=n.checkTime(o),i=n.checkTime(i),n.setData({limit_time:{days:e<0?"00":e,hours:a<0?"00":a,mins:o<0?"00":o,secs:i<0?"00":i}})},1e3)},checkTime:function(t){return t<0?"00":(t<10&&(t="0"+t),t)},goHome:function(t){wx.redirectTo({url:"/pages/pt/index/index"})},goToGroup:function(t){wx.navigateTo({url:"/pages/pt/group/details?oid="+t.target.dataset.id})},goToComment:function(t){wx.navigateTo({url:"/pages/pt/comment/comment?id="+this.data.goods.id})},goArticle:function(t){this.data.group_rule_id&&wx.navigateTo({url:"/pages/article-detail/article-detail?id="+this.data.group_rule_id})},hideAttrPicker:function(){this.setData({show_attr_picker:!1})},showAttrPicker:function(){this.setData({show_attr_picker:!0})},attrClick:function(t){var a=this,e=t.target.dataset.groupId,o=t.target.dataset.id,i=a.data.attr_group_list;for(var r in i)if(i[r].attr_group_id==e)for(var n in i[r].attr_list)i[r].attr_list[n].attr_id==o?i[r].attr_list[n].checked=!0:i[r].attr_list[n].checked=!1;a.setData({attr_group_list:i});var s=[],d=!0;for(var r in i){var c=!1;for(var n in i[r].attr_list)if(i[r].attr_list[n].checked){s.push(i[r].attr_list[n].attr_id),c=!0;break}if(!c){d=!1;break}}d&&(wx.showLoading({title:"正在加载",mask:!0}),app.request({url:api.group.goods_attr_info,data:{goods_id:a.data.goods.id,attr_list:JSON.stringify(s)},success:function(t){if(wx.hideLoading(),0==t.code){var e=a.data.goods;e.price=t.data.price,e.num=t.data.num,e.attr_pic=t.data.pic,e.original_price=t.data.single,a.setData({goods:e})}}}))},buyNow:function(){this.submit("GROUP_BUY")},onlyBuy:function(){this.submit("ONLY_BUY")},submit:function(t){var e=this;if(!e.data.show_attr_picker)return e.setData({show_attr_picker:!0}),!0;if(e.data.form.number>e.data.goods.num)return wx.showToast({title:"商品库存不足，请选择其它规格或数量",image:"/images/icon-warning.png"}),!0;var a=e.data.attr_group_list,o=[];for(var i in a){var r=!1;for(var n in a[i].attr_list)if(a[i].attr_list[n].checked){r={attr_id:a[i].attr_list[n].attr_id,attr_name:a[i].attr_list[n].attr_name};break}if(!r)return wx.showToast({title:"请选择"+a[i].attr_group_name,image:"/images/icon-warning.png"}),!0;o.push({attr_group_id:a[i].attr_group_id,attr_group_name:a[i].attr_group_name,attr_id:r.attr_id,attr_name:r.attr_name})}e.setData({show_attr_picker:!1}),wx.redirectTo({url:"/pages/pt/order-submit/order-submit?goods_info="+JSON.stringify({goods_id:e.data.goods.id,attr:o,num:e.data.form.number,type:t,deliver_type:e.data.goods.type})})},numberSub:function(){var t=this.data.form.number;if(t<=1)return!0;t--,this.setData({form:{number:t}})},numberAdd:function(){var t=this.data.form.number;++t>this.data.goods.one_buy_limit&&0!=this.data.goods.one_buy_limit?wx.showModal({title:"提示",content:"数量超过最大限购数",showCancel:!1,success:function(t){}}):this.setData({form:{number:t}})},numberBlur:function(t){var e=t.detail.value;e=parseInt(e),isNaN(e)&&(e=1),e<=0&&(e=1),e>this.data.goods.one_buy_limit&&0!=this.data.goods.one_buy_limit&&(wx.showModal({title:"提示",content:"数量超过最大限购数",showCancel:!1,success:function(t){}}),e=this.data.goods.one_buy_limit),this.setData({form:{number:e}})}},"countDown",function(){var s=this;setInterval(function(){var t=s.data.group_list;for(var e in t){var a=new Date(t[e].limit_time_ms[0],t[e].limit_time_ms[1]-1,t[e].limit_time_ms[2],t[e].limit_time_ms[3],t[e].limit_time_ms[4],t[e].limit_time_ms[5])-new Date,o=parseInt(a/1e3/60/60/24,10),i=parseInt(a/1e3/60/60%24,10),r=parseInt(a/1e3/60%60,10),n=parseInt(a/1e3%60,10);o=s.checkTime(o),i=s.checkTime(i),r=s.checkTime(r),n=s.checkTime(n),t[e].limit_time={days:o,hours:0<i?i:"00",mins:0<r?r:"00",secs:0<n?n:"00"},s.setData({group_list:t})}},1e3)}),_defineProperty(_Page,"bigToImage",function(t){var e=this.data.comment[t.target.dataset.index].pic_list;wx.previewImage({current:t.target.dataset.url,urls:e})}),_defineProperty(_Page,"showShareModal",function(){this.setData({share_modal_active:"active",no_scroll:!0})}),_defineProperty(_Page,"shareModalClose",function(){this.setData({share_modal_active:"",no_scroll:!1})}),_defineProperty(_Page,"getGoodsQrcode",function(){var e=this;if(e.setData({goods_qrcode_active:"active",share_modal_active:""}),e.data.goods_qrcode)return!0;app.request({url:api.group.goods_qrcode,data:{goods_id:e.data.id},success:function(t){0==t.code&&e.setData({goods_qrcode:t.data.pic_url}),1==t.code&&(e.goodsQrcodeClose(),wx.showModal({title:"提示",content:t.msg,showCancel:!1,success:function(t){t.confirm}}))}})}),_defineProperty(_Page,"goodsQrcodeClose",function(){this.setData({goods_qrcode_active:"",no_scroll:!1})}),_defineProperty(_Page,"goodsQrcodeClose",function(){this.setData({goods_qrcode_active:"",no_scroll:!1})}),_defineProperty(_Page,"saveGoodsQrcode",function(){var e=this;wx.saveImageToPhotosAlbum?(wx.showLoading({title:"正在保存图片",mask:!1}),wx.downloadFile({url:e.data.goods_qrcode,success:function(t){wx.showLoading({title:"正在保存图片",mask:!1}),wx.saveImageToPhotosAlbum({filePath:t.tempFilePath,success:function(){wx.showModal({title:"提示",content:"商品海报保存成功",showCancel:!1})},fail:function(t){wx.showModal({title:"图片保存失败",content:t.errMsg,showCancel:!1})},complete:function(t){console.log(t),wx.hideLoading()}})},fail:function(t){wx.showModal({title:"图片下载失败",content:t.errMsg+";"+e.data.goods_qrcode,showCancel:!1})},complete:function(t){console.log(t),wx.hideLoading()}})):wx.showModal({title:"提示",content:"当前微信版本过低，无法使用该功能，请升级到最新微信版本后重试。",showCancel:!1})}),_defineProperty(_Page,"goodsQrcodeClick",function(t){var e=t.currentTarget.dataset.src;wx.previewImage({urls:[e]})}),_defineProperty(_Page,"to_dial",function(){var t=this.data.store.contact_tel;wx.makePhoneCall({phoneNumber:t})}),_Page)); 
 			